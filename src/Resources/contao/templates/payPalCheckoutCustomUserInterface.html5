<?php
if ($this->bln_paymentAuthorized) {
    ?>

    <script type="application/javascript">
        console.log("loading div2")
        function reloadPaypalButton(){
            console.log("loading div")
            lsjs.loadingIndicator.__controller.show();

            new Request.cajax({
                url: document.location.href,
                method: 'post',
                noCache: true,
                cajaxMode: 'updateCompletely',
                data:	'cajaxRequestData[requestedElementClass]=paymentAndShippingOptionContainer,finishingOrderSubmitBox'
                    + '&REQUEST_TOKEN=' + lsjs.__appHelpers.merconisApp.obj_config.REQUEST_TOKEN
                    + '&payPalCheckout_reset=' + true,
                onComplete: function() {
                    lsjs.loadingIndicator.__controller.hide();
                },
                onSuccess: function(els, str_html, str_script) {
                    Browser.exec(str_script);
                }

            }).send();
        }

    </script>
    <button class="button" onclick=reloadPaypalButton()><?= $GLOBALS['TL_LANG']['MOD']['ls_shop']['paymentMethods']['payPalCheckout']['removeAuthorized']; ?></button>


    <p><?php echo $GLOBALS['TL_LANG']['MOD']['ls_shop']['paymentMethods']['payPalCheckout']['paymentAuthorized']; ?></p>
    <?php
} else {
    ?>
    <h3><?php echo $GLOBALS['TL_LANG']['MOD']['ls_shop']['paymentMethods']['payPalCheckout']['paymentWallHeadline']; ?></h3>
    <div id="paypal-button-container"></div>
    <script type="application/javascript">
        console.log("load Paypal button script")
        var myScript = Asset.javascript(
            'https://www.paypal.com/sdk/js?client-id=<?= $this->clientId ?>&currency=<?= $GLOBALS['TL_CONFIG']['ls_shop_currencyCode'] ?>&intent=authorize&commit=false',
            {
                onLoad: function(){
                    console.log( "<?= $this->clientId ?>");
                    console.log("erstelle mit orderid");
                    console.log("<?= $this->orderId ?>");
                    //console.log(paypal);
                    //---------------------------------------
                    paypal.Buttons({
                        style: {
                            color: "gold",
                            layout: "horizontal",
                            height: 48,
                            tagline: false,
                            shape: "rect"
                        },
                        onClick: (data, actions) => {

                        },
                        createOrder: (data, actions) => {
                            return "<?= $this->orderId ?>";
                        },
                        onApprove: function(data, actions) {
                            //$_SESSION['lsShopPaymentProcess']['payPalPlus']['authorized'] = true; // ?
                            // Authorize the transaction
                            actions.order.authorize().then(function(authorization) {

                                var authorizationID = authorization.purchase_units[0].payments.authorizations[0].id

                                console.log('Order ID:  ' + data.orderID);
                                console.log('Authorization ID: ' + authorizationID);


                                lsjs.loadingIndicator.__controller.show();

                                new Request.cajax({
                                    url: document.location.href,
                                    method: 'post',
                                    noCache: true,
                                    cajaxMode: 'updateCompletely',
                                    data:	'cajaxRequestData[requestedElementClass]=paymentAndShippingOptionContainer,finishingOrderSubmitBox'
                                        + '&REQUEST_TOKEN=' + lsjs.__appHelpers.merconisApp.obj_config.REQUEST_TOKEN
                                        + '&payPalCheckout_orderId=' + data.orderID
                                        + '&payPalCheckout_authorizationId=' + authorizationID,
                                    onComplete: function() {
                                        lsjs.loadingIndicator.__controller.hide();
                                    },
                                    onSuccess: function(els, str_html, str_script) {
                                        Browser.exec(str_script);
                                    }

                                }).send();
                            });
                        },/*
                        onApprove: async (data, actions) => {
                            console.log(actions)
                            //bestÃ¤tige Order
                            const order = await actions.order.capture()
                            console.log(order)
                        },*/
                        onCancel: () => {
                            //cancel message
                        },
                        onError: (err) => {
                            console.log(err)
                            //error message
                            console.log(err);
                        }

                    }).render('#paypal-button-container');
                }
            }
        );
    </script>
    <?php
}
?>

